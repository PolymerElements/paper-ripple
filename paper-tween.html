<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="paper-clock.html">

<!--
A tween class that also stores the current value of the underlying property.
-->

<script>
  (function(scope) {
    /**
     * A tween class that also stores the current value of the underlying property.
     * @param {PaperClock=} opt_clock
     * @param {number=} opt_startValue
     * @constructor
     */
    scope.PaperTween = function(opt_clock, opt_startValue) {
      /**
       * @private {PaperClock|undefined}
       */
      this.clock_ = opt_clock;

      /**
       * The duration of the animation.
       * @private {number}
       */
      this.duration_ = 0;

      /**
       * @private {Array<number>}
       */
      this.range_ = null;

      /**
       * @private {number|null}
       */
      this.startTime_ = null;

      /**
       * @private {number}
       */
      this.currentValue_ = opt_startValue || 0;

      /**
       * @private {string}
       */
      this.easing_ = 'linear';

      /**
       * A function to call after the current animation is finished.
       * @private {?function()}
       */
      this.onFinish_ = null;

      /**
       * A time delay offset for the animation.
       * @private {number}
       */
      this.delay_ = 0;

      this.reset();
    };
    var PaperTween = scope.PaperTween;

    /**
     * A set of easing functions.
     */
    PaperTween.EasingFunction = {
      'linear': null,
      'log_decelerate': function(t) {
          return PaperTween.EasingFunction.computeLog_(t) /
              PaperTween.EasingFunction.computeLog_(1);
      }
    };


    /**
     * A customized log-based timing function.
     * This creates a more natural dissipation for the ripple effect.
     * @param {number} t
     * @return {number}
     * @private
     */
    PaperTween.EasingFunction.computeLog_ = function(t) {
      // Base: 400
      // Time scale: 1.4
      return 1 - Math.pow(400, -t / 1.4);
    };


    /**
     * @param {number} duration
     * @return {!PaperTween}
     */
    PaperTween.prototype.setDuration = function(duration) {
      this.duration_ = duration;
      return this;
    };


    /**
     * @param {number} start
     * @param {number} end
     * @return {!PaperTween}
     */
    PaperTween.prototype.setRange = function(start, end) {
      this.range_ = [start, end];
      return this;
    };


    /**
     * @param {string} func
     * @return {!PaperTween}
     */
    PaperTween.prototype.setEasing = function(func) {
      this.easing_ = func;
      return this;
    };


    /**
     * @param {number} delay
     * @return {!PaperTween}
     */
    PaperTween.prototype.setDelay = function(delay) {
      this.delay_ = delay;
      return this;
    };


    /** @return {number} */
    PaperTween.prototype.getValue = function() {
      return this.currentValue_;
    };


    /**
     * @param {number} value
     * @return {!PaperTween}
     */
    PaperTween.prototype.setValue = function(value) {
      this.currentValue_ = value;
      return this;
    };


    /**
     * @param {!PaperClock} clock
     * @return {!PaperTween}
     */
    PaperTween.prototype.setClock = function(clock) {
      this.clock_ = clock;
      return this;
    };


    /** Set tween ready to start. */
    PaperTween.prototype.start = function() {
      this.startTime_ = this.clock_.now();
    };


    /** @return {boolean} */
    PaperTween.prototype.isAnimating = function() {
      return this.startTime_ !== null;
    };


    /**
     * @param {function()} func
     * @return {!PaperTween}
     */
    PaperTween.prototype.onFinish = function(func) {
      this.onFinish_ = func;
      return this;
    };


    /**
     * Reset animation properties to default.
     * @return {!PaperTween}
     */
    PaperTween.prototype.reset = function() {
      this.duration_ = 0;
      this.range_ = null;
      this.startTime_ = null;
      this.easing_ = 'linear';
      this.onFinish_ = null;
      this.delay_ = 0;

      return this;
    };


    /**
     * Compute the new property value for the given time.
     * @param {number} t
     */
    PaperTween.prototype.update = function(t) {
      if (!this.duration_ || this.startTime_ === null) {
        return;
      }

      // Absolute elapsed time.
      t = t - (this.startTime_ + this.delay_);

      // Normalized tween time.
      var norm = t / this.duration_;
      if (norm > 1) {
        norm = 1;
      } else if (norm < 0) {
        norm = 0;
      }

      var easingFunc = PaperTween.EasingFunction[this.easing_];
      // EasingFunction['linear'] defaults to null, which means that no time transform
      // will be done.
      if (easingFunc) {
        norm = easingFunc(norm);
      }

      this.currentValue_ = this.range_[0] + norm * (this.range_[1] - this.range_[0]);

      if (norm === 1) {
        this.startTime_ = null;

        if (this.onFinish_) {
          this.onFinish_();
          this.onFinish_ = null;
        }
      }
    };
  }(Polymer))
</script>
